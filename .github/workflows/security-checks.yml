name: Comprehensive Security Checks

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'requirements*.txt'
      - 'pyproject.toml'
      - '.github/workflows/security-*.yml'
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run comprehensive security checks weekly
    - cron: '0 2 * * 1'

env:
  PYTHON_VERSION: '3.11'

permissions:
  contents: read
  security-events: write
  packages: read

jobs:
  # ===== STATIC APPLICATION SECURITY TESTING (SAST) =====
  sast:
    name: Static Application Security Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install bandit semgrep pylint

      - name: Run Bandit (Python security linter)
        run: |
          echo "üîç Running Bandit security linter..."
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ -ll

      - name: Run Semgrep (pattern-based SAST)
        run: |
          echo "üîç Running Semgrep security patterns..."
          pip install semgrep
          semgrep --config=p/security-audit src/ --json -o semgrep-report.json || true

      - name: Run Pylint security checks
        run: |
          echo "üîç Running Pylint security checks..."
          pylint src/ --fail-under=8.0 --max-line-length=100 || true

      - name: Upload SAST results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sast-reports
          path: |
            bandit-report.json
            semgrep-report.json

  # ===== DEPENDENCY VULNERABILITY SCANNING =====
  dependency-check:
    name: Dependency Vulnerability Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pip-audit
        run: |
          echo "üîç Scanning dependencies with pip-audit..."
          pip install pip-audit
          pip-audit --desc --skip-editable || true

      - name: Run safety check
        run: |
          echo "üîç Scanning dependencies with Safety..."
          pip install safety
          safety check --json || true

      - name: Check for outdated packages
        run: |
          echo "üîç Checking for outdated packages..."
          pip install pip-tools
          pip list --outdated

  # ===== SECRET SCANNING =====
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Run truffleHog
        run: |
          echo "üîç Scanning for secrets with TruffleHog..."
          pip install truffleHog
          truffleHog filesystem . --json || true

      - name: Run detect-secrets
        run: |
          echo "üîç Scanning for secrets with detect-secrets..."
          pip install detect-secrets
          detect-secrets scan --all-files > .secrets.baseline || true
          detect-secrets audit .secrets.baseline || true

      - name: Git credentials check
        run: |
          echo "üîç Checking for hardcoded credentials..."
          if git log --all -p | grep -iE 'password|api[_-]?key|secret|token' > /dev/null; then
            echo "‚ö†Ô∏è  WARNING: Potential credentials found in git history"
            echo "    Review manually to ensure they are not actual secrets"
          fi

  # ===== CONTAINER SECURITY =====
  container-security:
    name: Container Image Security
    runs-on: ubuntu-latest
    if: hashFiles('Dockerfile') != ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          echo "üê≥ Building Docker image..."
          docker build -t vulnreach:latest .

      - name: Scan with Trivy
        run: |
          echo "üîç Scanning image with Trivy..."
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image --severity HIGH,CRITICAL vulnreach:latest

      - name: Scan with Grype
        run: |
          echo "üîç Scanning image with Grype..."
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
          /usr/local/bin/grype vulnreach:latest

      - name: Check Dockerfile best practices
        run: |
          echo "üîç Checking Dockerfile with hadolint..."
          docker run --rm -i hadolint/hadolint < Dockerfile || true

  # ===== CODE QUALITY & SECURITY METRICS =====
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install radon flake8 coverage

      - name: Cyclomatic complexity check
        run: |
          echo "üîç Analyzing cyclomatic complexity..."
          pip install radon
          radon cc src/ -a -j

      - name: Maintainability index
        run: |
          echo "üîç Calculating maintainability index..."
          radon mi src/

      - name: Code coverage analysis
        run: |
          echo "üîç Running code coverage analysis..."
          if [ -d "tests" ]; then
            pip install pytest pytest-cov
            pytest tests/ --cov=src --cov-report=term-report:coverage.txt --cov-report=json || true
          else
            echo "‚ö†Ô∏è  No tests directory found"
          fi

  # ===== SECURITY UNIT TESTS =====
  security-tests:
    name: Security Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pydantic

      - name: Create security tests
        run: |
          mkdir -p tests/security
          
          cat > tests/security/test_input_validation.py << 'EOF'
import pytest
from vulnreach.security.validator import (
    validate_filepath,
    validate_cve_id,
    validate_command_argument,
    SecurityValidationError
)

class TestInputValidation:
    """Test input validation security"""

    def test_path_traversal_protection(self):
        """Ensure path traversal attacks are prevented"""
        with pytest.raises(SecurityValidationError):
            validate_filepath("../../etc/passwd")

    def test_null_byte_protection(self):
        """Ensure null bytes are detected"""
        with pytest.raises(SecurityValidationError):
            validate_filepath("/tmp/file\x00.txt")

    def test_command_injection_protection(self):
        """Ensure command injection is prevented"""
        with pytest.raises(SecurityValidationError):
            validate_command_argument("test; rm -rf /")

        with pytest.raises(SecurityValidationError):
            validate_command_argument("test && curl malicious.com")

    def test_cve_id_validation(self):
        """Test CVE ID validation"""
        assert validate_cve_id("CVE-2021-44228") == "CVE-2021-44228"

        with pytest.raises(SecurityValidationError):
            validate_cve_id("INVALID-CVE")

if __name__ == "__main__":
    pytest.main([__file__, "-v"])
EOF

      - name: Run security tests
        run: |
          python -m pytest tests/security/ -v || true

  # ===== CONFIGURATION SECURITY =====
  config-security:
    name: Configuration Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for insecure defaults
        run: |
          echo "üîç Checking for insecure configuration defaults..."
          
          # Check debug mode isn't enabled in production
          if grep -r "DEBUG.*=.*True" src/ | grep -v test; then
            echo "‚ö†Ô∏è  WARNING: DEBUG mode appears to be enabled in source files"
          fi
          
          # Check hardcoded credentials
          if grep -rE '(password|api_key|secret|token)\s*=\s*["\'][^"\']*["\']' src/ | grep -v test; then
            echo "‚ö†Ô∏è  WARNING: Hardcoded credentials found"
          fi

      - name: Verify secure configurations
        run: |
          echo "üîç Verifying secure configurations..."
          
          # Check pyproject.toml for secure dependencies
          if [ -f "pyproject.toml" ]; then
            echo "‚úì pyproject.toml exists"
          fi
          
          # Check requirements have locked versions
          if [ -f "requirements-lock.txt" ]; then
            echo "‚úì requirements-lock.txt exists"
          else
            echo "‚ö†Ô∏è  Consider creating requirements-lock.txt for reproducible builds"
          fi

  # ===== SUMMARY REPORT =====
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [sast, dependency-check, secret-scan, code-quality]
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate security report
        run: |
          echo "# üõ°Ô∏è  Security Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "- SAST: Completed" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Scanning: Completed" >> $GITHUB_STEP_SUMMARY
          echo "- Secret Detection: Completed" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality: Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Security reports are available in the artifacts section" >> $GITHUB_STEP_SUMMARY

      - name: Check security failures
        run: |
          echo "üîç Checking for critical security issues..."
          # Add your logic to fail the workflow on critical issues

